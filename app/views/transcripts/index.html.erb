<% content_for :head do %>
  <title>Abstract::Transcripts</title>
<% end %>

<script type="text/javascript">
$(function() {
  var curr_date = new Date();
  $('#to_datepicker').datepicker();
  $('#to_datepicker').val(curr_date.toLocaleDateString());
  $('#from_datepicker').datepicker();
  curr_date.setFullYear(curr_date.getFullYear()-10);
  $('#from_datepicker').val(curr_date.toLocaleDateString());
});

function chooseDeal()
{
  $('#transcript_table').css('display','none');
  $('#frame_div').css('display','block');
  $('#frame').attr('src', 'deals');
  $('#titleFrame').html('Deals');
  $('#submit').click(function() {
    var selRow = $('#frame').contents().find('#deals_list')
                            .getGridParam('selrow');
    if (selRow != null)
    {
      $('#choose_deal').val($('#frame').contents().find('#deals_list')
                                       .getCell(selRow, 'tag'));
      $('#deal_id').val($('#frame').contents().find('#deals_list')
                                              .getCell(selRow, 'id'));
      $('#transcript_table').css('display','block');
      $('#frame_div').css('display','none');
      $('#frame').attr('src', '');
      $("#submit").unbind("click");
    }
  });
}
function discardChoose()
{
  $('#transcript_table').css('display','block');
  $('#frame_div').css('display','none');
  $('#frame').attr('src', '');
  $("#submit").unbind("click");
}
function loadTranscript()
{
  action = $.ajax({url: '/transcripts/load?deal_id=' + $("#deal_id").val() +
                                   '&start=' + $("#from_datepicker").val() +
                                   '&stop=' + $("#to_datepicker").val()});
  action.complete(function() {
    var actionUrl = '/transcripts/load?deal_id=' + $("#deal_id").val() +
                                     '&start=' + $("#from_datepicker").val() +
                                     '&stop=' + $("#to_datepicker").val() +
                                     '&source=grid';
    $('#transcripts_list').setGridParam({url: actionUrl});
    $('#transcripts_list').clearGridData(true);
    $('#transcripts_list').trigger('reloadGrid');
  });
}
function chooseAccounting()
{
  $('#transcripts_list').showCol('h_debit');
  $('#transcripts_list').showCol('h_credit');
  $('#transcripts_list').hideCol('debit');
  $('#transcripts_list').hideCol('credit');
  chooseUnit();
}
function choosePhysical()
{
  $('#transcripts_list').showCol('debit');
  $('#transcripts_list').showCol('credit');
  $('#transcripts_list').hideCol('h_debit');
  $('#transcripts_list').hideCol('h_credit');
  chooseUnit();
}
function chooseUnit()
{
  var fromDebit = $('#fromDebit').html();
  var fromCredit = $('#fromCredit').html();
  var turnoversDebit = $('#turnoversDebit').html();
  var turnoversCredit = $('#turnoversCredit').html();
  var exchangeDebit = $('#exchangeDebit').html();
  var exchangeCredit = $('#exchangeCredit').html();
  var toDebit = $('#toDebit').html();
  var toCredit = $('#toCredit').html();

  $('#fromDebit').html($('#hFromDebit').val());
  $('#fromCredit').html($('#hFromCredit').val());
  $('#turnoversDebit').html($('#hTurnoversDebit').val());
  $('#turnoversCredit').html($('#hTurnoversCredit').val());
  $('#exchangeDebit').html($('#hExchangeDebit').val());
  $('#exchangeCredit').html($('#hExchangeCredit').val());
  $('#toDebit').html($('#hToDebit').val());
  $('#toCredit').html($('#hToCredit').val());

  $('#hFromDebit').val(fromDebit);
  $('#hFromCredit').val(fromCredit);
  $('#hTurnoversDebit').val(turnoversDebit);
  $('#hTurnoversCredit').val(turnoversCredit);
  $('#hExchangeDebit').val(exchangeDebit);
  $('#hExchangeCredit').val(exchangeCredit);
  $('#hToDebit').val(toDebit);
  $('#hToCredit').val(toCredit);
}
</script>

<table id="transcript_table">
  <tr>
    <td colspan="2" align="right" style="width: 800px">
      <input type="button" id="cancel" value="cancel" disabled="true"/>
      <input type="button" id="load" value="load" onclick="loadTranscript();"/>
    </td>
  </tr>
  <tr>
    <td id="loadData" colspan="2">
      <div id="beforeLoadData">
        deal
        <input type="button" id="choose_deal" value="click to choose"
               onclick="chooseDeal();"/>
        <input type="hidden" id="deal_id" value=""/>
        from
        <input type="text" id="from_datepicker"/>
        to
        <input type="text" id="to_datepicker"/>
      </div>
      <div id="afterLoadData" style="display: none">
        deal
        <a id="loadedDeal"> </a>
        <br>
          units
          physical
          <input type="radio" id="physical" name="unit" checked="true"
                 onchange="choosePhysical();"/>
          accounting
          <input type="radio" id="accounting" name="unit"
                 onchange="chooseAccounting();"/>
        </br>
      </div>
    </td>
  </tr>
  <tr>
    <td align="left">
      <a id="fromDate"></a>
    </td>
    <td align="right">
      <a id="fromDebit"></a>
      <input type="hidden" id="hFromDebit" value=""/>
      <a id="fromCredit"></a>
      <input type="hidden" id="hFromCredit" value=""/>
    </td>
  </tr>
  <tr>
    <td colspan="2">
      <table id="transcripts_list"></table>
      <div id="transcripts_pager"></div>
      <% content_for :head do %>
        <%= raw(transcripts_jqgrid) %>
      <% end %>
    </td>
  </tr>
  <tr>
    <td align="left">
      Total turnovers
    </td>
    <td align="right">
      <a id="turnoversDebit"></a>
      <input type="hidden" id="hTurnoversDebit" value=""/>
      <a id="turnoversCredit"></a>
      <input type="hidden" id="hTurnoversCredit" value=""/>
    </td>
  </tr>
  <tr>
    <td align="left">
      Exchange differences
    </td>
    <td align="right">
      <a id="exchangeDebit"></a>
      <input type="hidden" id="hExchangeDebit" value=""/>
      <a id="exchangeCredit"></a>
      <input type="hidden" id="hExchangeCredit" value=""/>
    </td>
  </tr>
  <tr>
    <td align="left">
      <a id="toDate"></a>
    </td>
    <td align="right">
      <a id="toDebit"></a>
      <input type="hidden" id="hToDebit" value=""/>
      <a id="toCredit"></a>
      <input type="hidden" id="hToCredit" value=""/>
    </td>
  </tr>
</table>

<div id="frame_div" style="display: none">
  <table>
    <tr align="right">
      <td>
        <input type="button" id="discard" value="discard" onclick="discardChoose();"/>
        <input type="button" id="submit" value="submit" onclick=""/>
      </td>
    </tr>
    <tr>
      <td id="titleFrame">
      </td>
    </tr>
    <tr>
      <td>
        <iframe id="frame" src="" width=830 height=500 scrolling=no
                noresize border=0 frameborder=no>
        </iframe>
      </td>
    </tr>
  </table>
</div>
