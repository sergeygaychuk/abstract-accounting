<script type="text/javascript">
  var lastSelId = "";
  var canSave = true;

  $(function() {
    $("#storehouse_date").datepicker($.datepicker.regional['<%= I18n.locale.to_s %>']);
  });

  function check_storehouse_waybill(id) {
   if(!$("#check_" + id).is(":checked")) {
     $("#storehouse_release_list").setCell(id, 'release',' ');
   } else {
     $("#storehouse_release_list").setCell(id, 'release',
       $("#storehouse_release_list").getCell(id, 'amount'));
   }
   $("#storehouse_release_list").setSelection(id);
  }
  function sendRelease() {
    $("#storehouse_release_list").saveRow(lastSelId);
    dataPage = new Object();
    dataPage["dataGrid"] = storeHouseData;
    dataPage["to"] = $("#storehouse_to").val();
    dataPage["date"] = $("#storehouse_date").val();
    var d = new Date($("#storehouse_date").val());
    d.setHours(12);
    var entries = "";
    for (var i in storeHouseData) {
      entries += "&resource_id[]=" + i + "&release_amount[]=" + storeHouseData[i];
    }
    $.ajax({url: "/storehouses/releases/create?to=" + $("#storehouse_to").val() +
                  "&date=" + d.toUTCString() + entries});
  }
  function saveEdittedReleaseRow() {
    if(canSave) $("#storehouse_release_list").saveRow(lastSelId);
  }
  function filterEntryGrid(state) {
    if(state == 0) {
      $("#release_entry_table").html("<%= escape_javascript(render :partial =>
        'storehouses/release_entries_by_resource') %>");
    } else {
      $("#release_entry_table").html("<%= escape_javascript(render :partial =>
        'storehouses/release_entries_by_waybill') %>");
    }
  }
</script>

<%= raw(storehouse_release_jqgrid) %>

<%= form_for(:release, :remote => true) do |f| %>
<%= f.error_messages %>
<% end %>
<table>
  <tbody>
    <tr align="right">
      <td colspan="2">
        * - <%=t 'reqFields'%>
      </td>
    </tr>
    <tr align="left">
      <td>
        <%=t 'storehouse.date'%>*:
      </td>
      <td align="right">
        <input type="text" id="storehouse_date" value="" size="50"/>
      </td>
    </tr>
    <tr>
      <td align="left">
        <%=t 'storehouse.to'%>*:
      </td>
      <td align="right">
        <input type="text" id="storehouse_to" value="" size="50"/>
      </td>
    </tr>
    <tr>
      <td align="left" colspan="2">
        <div>
          <a href="#storehouses/releases/new" onclick="filterEntryGrid(0)" style="margin-left:5px;margin-right:5px">
            <%= t 'storehouse.filt_resource' %>
          </a>
          <a href="#storehouses/releases/new" onclick="filterEntryGrid(1)" style="margin-left:5px;margin-right:5px">
            <%= t 'storehouse.filt_waybills' %>
          </a>
        </div>
      </td>
    </tr>
    <tr>
      <td colspan="2" onmousedown="canSave = true;" onmouseup="saveEdittedReleaseRow();">
        <div id="release_entry_table"></div>
      </td>
    </tr>
    <tr>
      <td colspan="2" align="right">
        <input type="button" value="<%=t 'storehouse.btn_save'%>" onclick="sendRelease();"/>
      </td>
    </tr>
  </tbody>
</table>
