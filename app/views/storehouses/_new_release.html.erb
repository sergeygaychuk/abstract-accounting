<script type="text/javascript">
  var listAction = "";
  var lastSelId = "";
  var canSave = true;

  $(function() {
    $("#storehouse_date").datepicker($.datepicker.regional['<%= I18n.locale.to_s %>']);
  });

  function check_storehouse_waybill(id) {
   if(!$("#check_" + id).is(":checked")) {
     $("#storehouse_release_list").setCell(id, 'release',' ');
   } else {
     $("#storehouse_release_list").setCell(id, 'release',
       $("#storehouse_release_list").getCell(id, 'amount'));
   }
   $("#storehouse_release_list").setSelection(id);
  }
  function sendRelease() {
    dataPage = new Object();
    dataPage["dataGrid"] = storeHouseData;
    if($("#gbox_release_waybills_tree").html()) {
      if(lastSubgridTableId) {
        $("#" + lastSubgridTableId).saveRow(lastSelId);
      }
      var tmpData = new Object();
      for (var i in storeHouseData) {
        for (var j in storeHouseData[i]) {
          if(tmpData[j]) {
            tmpData[j] += parseInt(storeHouseData[i][j]);
          } else {
            tmpData[j] = parseInt(storeHouseData[i][j]);
          }
        }
      }
      storeHouseData = tmpData;
    } else {
      $("#storehouse_release_list").saveRow(lastSelId);
    }
    dataPage["to"] = $("#storehouse_to").val();
    dataPage["date"] = $("#storehouse_date").val();
    var d = new Date($("#storehouse_date").val());
    d.setHours(12);
    var entries = "";
    for (var i in storeHouseData) {
      entries += "&resource_id[]=" + i + "&release_amount[]=" + storeHouseData[i];
    }
    $.ajax({url: "/storehouses/releases/create?to=" + $("#storehouse_to").val() +
                  "&date=" + d.toUTCString() + entries});
  }
  function saveEdittedReleaseRow() {
    if(canSave) {
      if($("#gbox_storehouse_release_list").html() != null) {
        $("#storehouse_release_list").saveRow(lastSelId);
      } else {
        $("#" + lastSubgridTableId).saveRow(lastSelId);
      }
    }
  }
  function check_waybill(id) {
    if(!$("#check_waybill_" + id).is(":checked")) {
      for(var i=0; i<$("#release_waybills_tree_" + id + "_t").getRowData().length; i++) {
        var row_id = $("#release_waybills_tree_" + id + "_t").getDataIDs()[i];
        $("#check_entry_" + id + "_" + row_id).removeAttr("checked");
        $("#release_waybills_tree_" + id + "_t").setCell(row_id, "release", " ");
      }
      delete storeHouseData[id];
    } else {
      if($("#release_waybills_tree_" + id + "_t").html()) {
        for(var i=0; i<$("#release_waybills_tree_" + id + "_t").getRowData().length; i++) {
          var row_id = $("#release_waybills_tree_" + id + "_t").getDataIDs()[i];
          $("#check_entry_" + id + "_" + row_id).attr("checked", "checked");
          $("#release_waybills_tree_" + id + "_t").setCell(row_id, "release",
            $("#release_waybills_tree_" + id + "_t").getCell(row_id, "amount"));
        }
      } else {
        listAction = "check_waybill";
        $("#release_waybills_tree").expandSubGridRow(id);
      }
    }
  }
  function check_release_waybill(sub_id, row_id) {
    if(!$("#check_entry_" + sub_id + "_" + row_id).is(":checked")) {
      $("#release_waybills_tree_" + sub_id + "_t").setCell(row_id, "release", " ");
      uncheckParentWaybill(sub_id);
    } else {
      $("#release_waybills_tree_" + sub_id + "_t").setCell(row_id, "release",
        $("#release_waybills_tree_" + sub_id + "_t").getCell(row_id, "amount"));
      $("#release_waybills_tree_" + sub_id + "_t").setSelection(row_id);
      $("#check_waybill_" + sub_id).attr("checked", "checked");
    }
  }
  function uncheckParentWaybill(sub_id) {
      var dataIDs = $("#release_waybills_tree_" + sub_id + "_t").getDataIDs();
      for(var i=0; i<dataIDs.length; i++) {
        if($("#check_entry_" + sub_id + "_" + dataIDs[i]).is(":checked")) {
          return;
        }
      }
      $("#check_waybill_" + sub_id).removeAttr("checked");
  }
</script>

<%= raw(storehouse_release_jqgrid) %>

<%= form_for(:release, :remote => true) do |f| %>
<%= f.error_messages %>
<% end %>
<table>
  <tbody>
    <tr align="right">
      <td colspan="2">
        * - <%=t 'reqFields'%>
      </td>
    </tr>
    <tr align="left">
      <td>
        <%=t 'storehouse.date'%>*:
      </td>
      <td align="right">
        <input type="text" id="storehouse_date" value="" size="50"/>
      </td>
    </tr>
    <tr>
      <td align="left">
        <%=t 'storehouse.to'%>*:
      </td>
      <td align="right">
        <input type="text" id="storehouse_to" value="" size="50"/>
      </td>
    </tr>
    <tr>
      <td align="left" colspan="2">
        <div>
          <a href="#storehouses/releases/new?filter=waybill" onclick="dataPage = null;"
             style="margin-left:5px;margin-right:5px">
            <%= t 'storehouse.filt_waybills' %>
          </a>
          <a href="#storehouses/releases/new?filter=resource" onclick="dataPage = null;"
             style="margin-left:5px;margin-right:5px">
            <%= t 'storehouse.filt_resource' %>
          </a>
        </div>
      </td>
    </tr>
    <tr>
      <td colspan="2" onmousedown="canSave = true;" onmouseup="saveEdittedReleaseRow();">
        <div id="release_entry_table"></div>
      </td>
    </tr>
    <tr>
      <td colspan="2" align="right">
        <input type="button" value="<%=t 'storehouse.btn_save'%>" onclick="sendRelease();"/>
      </td>
    </tr>
  </tbody>
</table>
