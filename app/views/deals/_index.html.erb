<script type="text/javascript">
  var canSelectDeal = true;

  function changeDealDirRate()
  {
    if($("#deal_rate").val() != "")
    {
      $("#deal_rate").val(1/$("#deal_rate").val());
    }
  }
  function dealChoiseEntity()
  {
    crossPage = "deal";
    crossPageLink = "deals/new";
    $("#deals_div").css("display","none");
    $("#deal_p_s_controls").css("display","block");
    $("#deal_page_selection").html("<%= escape_javascript(render :partial => 'entities/index') %>");
    $("#deal_submit").click(function() {
      var selRow = $("#entity_list").getGridParam("selrow");
      if (selRow != null)
      {
        $("#hide_deal_entity_id").val(selRow);
        $("#deal_entity_tag").val($("#entity_list").getCell(selRow, "tag"));
        showDealPage();
      }
    });
  }
  function showDealPage()
  {
    $("#deals_div").css("display","block");
    $("#deal_p_s_controls").css("display","none");
    $("#deal_page_selection").html("");
    $("#deal_submit").unbind("click");
    crossPage = "";
  }
  function dealChoiseResource(type)
  {
    crossPage = "deal";
    crossPageLink = "deals/new";
    $("#deals_div").css("display","none");
    $("#deal_p_s_controls").css("display","block");
    ajaxRequest("resources");
    
    $("#deal_submit").click(function() {
      var selRow = $("#resources_list").getGridParam("selrow");
      if (selRow != null)
      {
        $("#deal_" + type + "_tag").val($("#resources_list").getCell(selRow, "tag"));
        $("#hide_deal_" + type + "_id").val($("#resources_list")
                                                .getCell(selRow, "id"));
        $("#hide_deal_" + type + "_type").val($("#resources_list")
                                                .getCell(selRow, "type"));
        showDealPage();
      }
    });
  }
  function beforeDealSave()
  {
    if((dataPage != null) && (dataPage["rules"].length > 0)) {
      var url = "";
      for(var i = 0; i < dataPage["rules"].length; i++) {
        if(i == 0) {
          url += "?";
        } else {
          url += "&";
        }
        url += "rules[][tag]=" + dataPage["rules"][i]["tag"];
        url += "&rules[][from_id]=" + dataPage["rules"][i]["from_id"];
        url += "&rules[][to_id]=" + dataPage["rules"][i]["to_id"];
        url += "&rules[][fact_side]=" + dataPage["rules"][i]["fact_side"];
        url += "&rules[][change_side]=" + dataPage["rules"][i]["change_side"];
        url += "&rules[][rate]=" + dataPage["rules"][i]["rate"];
      }
      $("#new_deal").attr("action", $("#new_deal").attr("action") + url);
    }
    $("#hide_deal_tag").val(escape($("#deal_tag").val()));
    if($("#dir_1").attr("checked") && ($("#deal_rate").val() != "")) {
      $("#hide_deal_rate").val(1/$("#deal_rate").val());
    } else {
      $("#hide_deal_rate").val(escape($("#deal_rate").val()));
    }
    if($("#isOfBalance").attr("checked")) {
      $("#hide_is_off_balance").val("1");
    } else {
      $("#hide_is_off_balance").val("0");
    }
  }
  function disabledElements()
  {
    $("#dir_0").attr("checked", "checked");
    $("#dir_0").attr("disabled", "disabled");
    $("#dir_1").attr("disabled", "disabled");
    $("#deal_tag").val("");
    $("#deal_tag").attr("disabled", "disabled");
    $("#deal_entity_tag").val("");
    $("#deal_entity_choose").removeAttr("disabled");
    $("#deal_give_tag").val("");
    $("#deal_give_choose").attr("disabled","disabled");
    $("#deal_take_tag").val("");
    $("#deal_take_choose").attr("disabled","disabled");
    $("#deal_rate").val("");
    $("#deal_rate").attr("disabled","disabled");
    $("#isOfBalance").attr("disabled","disabled");
    $("#deal_rules").attr("disabled","disabled");
  }
  function enabledElements()
  {
    $("#dir_0").removeAttr("disabled");
    $("#dir_1").removeAttr("disabled");
    $("#dir_0").attr("checked","checked");
    $("#deal_tag").val("");
    $("#deal_tag").removeAttr("disabled");
    $("#deal_entity_tag").val("");
    $("#deal_entity_choose").removeAttr("disabled");
    $("#deal_give_tag").val("");
    $("#deal_give_choose").removeAttr("disabled");
    $("#deal_take_tag").val("");
    $("#deal_take_choose").removeAttr("disabled");
    $("#deal_rate").val("");
    $("#deal_rate").removeAttr("disabled");
    $("#hide_deal_tag").val("");
    $("#hide_deal_rate").val("");
    $("#hide_deal_entity_id").val("");
    $("#hide_deal_give_id").val("");
    $("#hide_deal_give_type").val("");
    $("#hide_deal_take_id").val("");
    $("#hide_deal_take_type").val("");
    $("#hide_is_off_balance").val("");
    $("#isOfBalance").removeAttr("disabled");
    $("#isOfBalance").removeAttr("checked");
    $("#deal_rules").removeAttr("disabled");
  }
  function showDealIndexForm()
  {
    dataPage = null;
    if(crossPage.length) {
      $("#deal_actions").html("<%= escape_javascript(render :partial => 'deals/form_index') %>");
      $("#deals_list").trigger("reloadGrid");
      disabledElements();
      canSelectDeal = true;
      cancelRequest = true;
      location.hash = crossPageLink;
    } else {
      location.hash = "#deals";
    }
  }
  function onCancelDeal()
  {
    showDealIndexForm();
  }
  function onResetDeal()
  {
    enabledElements();
    $("#save_deal").attr("disabled","disabled");
    dataPage = null;
  }
  function showRules()
  {
    if($("#new_deal").length) {
      rememberDealElements();
      location.hash = "rules";
    } else {
      location.hash = "rules/view?deal_id=" + $("#deals_list").getGridParam("selrow");
    }
  }
  function rememberDealElements()
  {
    dataPage = new Object();
    dataPage["url"] = location.hash;
    dataPage["isOffBalance"] = $("#isOfBalance").attr("checked");
    dataPage["tag"] = $("#deal_tag").val();
    dataPage["entity_id"] = $("#hide_deal_entity_id").val();
    dataPage["entity_tag"] = $("#deal_entity_tag").val();
    dataPage["give_id"] = $("#hide_deal_give_id").val();
    dataPage["give_type"] = $("#hide_deal_give_type").val();
    dataPage["give_tag"] = $("#deal_give_tag").val();
    dataPage["take_id"] = $("#hide_deal_take_id").val();
    dataPage["take_type"] = $("#hide_deal_take_type").val();
    dataPage["take_tag"] = $("#deal_take_tag").val();
    dataPage["dir_0"] = $("#dir_0").attr("checked");
    dataPage["dir_1"] = $("#dir_1").attr("checked");
    dataPage["rate"] = $("#deal_rate").val();
  }
  function loadDealElements()
  {
    if(dataPage["isOffBalance"]) $("#isOfBalance").attr("checked","checked");
    $("#deal_tag").val(dataPage["tag"]);
    $("#hide_deal_entity_id").val(dataPage["entity_id"]);
    $("#deal_entity_tag").val(dataPage["entity_tag"]);
    $("#hide_deal_give_id").val(dataPage["give_id"]);
    $("#hide_deal_give_type").val(dataPage["give_type"]);
    $("#deal_give_tag").val(dataPage["give_tag"]);
    $("#hide_deal_take_id").val(dataPage["take_id"]);
    $("#hide_deal_take_type").val(dataPage["take_type"]);
    $("#deal_take_tag").val(dataPage["take_tag"]);
    if(dataPage["dir_0"]) $("#dir_0").attr("checked","checked");
      else $("#dir_1").attr("checked","checked");
    $("#deal_rate").val(dataPage["rate"]);
    $("#save_deal").removeAttr("disabled");
  }
</script>

<%= raw(deals_jqgrid) %>

<div id="deals_div">
  <table id="deals_list"></table>
  <div id="deals_pager"></div>

  <table>
    <tr id="deal_actions" align="right">
      <%= render 'deals/form_index' %>
    </tr>
    <tr align="right">
      <td colspan="2">
        <input type="checkbox" id="isOfBalance" disabled="true">
          <%= t('deal.isoffbalance')%>
        </input>
      </td>
    </tr>
    <tr align="left">
      <td colspan="2">
        <%= t('deal.tag')%>:
        <input id="deal_tag" type="text" disabled="true" value="" size="83"
               onkeypress="$('#save_deal').removeAttr('disabled');"/>
      </td>
    </tr>
    <tr align="left">
      <td colspan="2">
        <%= t('deal.entity')%>:
        <input id="deal_entity_tag" type="text" disabled="true" value="" size="72" />
        <input id="deal_entity_choose" type="button" value="<%= t('deal.btn_choose')%>" disabled="true"
               onclick="dealChoiseEntity();"/>
      </td>
    </tr>
    <tr>
      <td colspan="2">
        <table>
          <tr align="left">
            <td align="left">
              <br> <%= t('deal.giveResource')%> </br>
              <br> <input id="deal_give_tag" type="text" disabled="true" value=""
                          size="30" /> </br>
              <br> <input id="deal_give_choose" type="button" value="<%= t('deal.btn_choose')%>"
                          disabled="true" onclick="dealChoiseResource('give');"/> </br>
            </td>
            <td align="center">
              <br><%= t('deal.rate')%></br>
              <br> <input type="radio" id="dir_0" name="direction" checked="true"
                          disabled="true" onchange="changeDealDirRate();"/> --> </br>
              <br> <input type="radio" id="dir_1" name="direction"
                          disabled="true" onchange="changeDealDirRate();"/> <-- </br>
              <br> <input id="deal_rate" type="text" disabled="true" value=""
                          size="20" /> </br>
            </td>
            <td align="right">
              <br> <%= t('deal.takeResource')%> </br>
              <br> <input id="deal_take_tag" type="text" disabled="true" value=""
                          size="30" /> </br>
              <br> <input id="deal_take_choose" type="button" value="<%= t('deal.btn_choose')%>"
                          disabled="true" onclick="dealChoiseResource('take');"/> </br>
            </td>
          </tr>
        </table>
      </td>
    </tr>
    <tr>
      <td align="left">
        <input type="button" id="deal_rules" value="<%= t('deal.rules')%>"
               onclick="showRules();" disabled="true"/>
      </td>
    </tr>
  </table>
</div>

<table id="deal_p_s_controls" style="display: none">
    <tr align="right">
      <td>
        <input type="button" value="<%= t('buttons.btn_discard')%>" onclick="showDealPage();"/>
        <input type="button" id="deal_submit" value="<%= t('buttons.btn_submit')%>" onclick=""/>
      </td>
    </tr>
    <tr id="deal_page_selection">
    </tr>
</table>

<script type="text/javascript">
  var filter = false;
  $("#deals_list").filterToolbar({searchOnEnter : false});
  $("#deals_list")[0].toggleToolbar();
</script>
