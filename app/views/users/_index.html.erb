<script type="text/javascript">
  var email = "";
  var roles = "";
  var entity_id = "";
  var entity_tag = "";
  var place_id = "";
  var place_tag = "";
  var canSelect = true;
  var changePass;
  function uncheckRoles(enabled)
  {
    <% for role in Role.find(:all) %>
      if(enabled)
      {
        $('#user_role_id_' + '<%= role.id.to_s %>').removeAttr('disabled');
      }
      else
      {
        $('#user_role_id_' + '<%= role.id.to_s %>').attr('disabled','disabled');
      }
      $('#user_role_id_' + '<%= role.id.to_s %>').removeAttr('checked');
    <% end %>
  }
  function sendDataUser()
  {
    <% for role in Role.all %>
      $('#role_ids_' + '<%= role.id.to_s %>').attr('checked',
        $('#user_role_id_' + '<%= role.id.to_s %>').is(':checked'));
    <% end %>
    $('#hide_email').val(escape($('#user_email').val()));
    $('#hide_pass').val($('#user_pass').val());
    $('#hide_pass_c').val($('#user_pass_c').val());
    saveUserElements();
  }
  function onReset()
  {
    $("#user_email").val(email);
    $("#user_pass").val("");
    $("#user_pass_c").val("");
    $("#user_entity_tag").val(entity_tag);
    $("#hide_user_entity_id").val(entity_id);
    $("#user_place_tag").val(place_tag);
    $("#hide_user_place_id").val(place_id);
    $("#save_user").attr("disabled","disabled");
    uncheckRoles("enabled");
    if(roles != "") {
      checkRoles(roles);
    }
  }
  function viewActionForm(emailValue, entityId, placeId, loadType)
  {
    canSelect = false;
    if(dataPage == null) {
      email = emailValue;
      entity_id = entityId;
      if(entityId == "") entity_tag = "";
      place_id = placeId;
      if(placeId == "") place_tag = "";
      onReset();
      $("#data_list").resetSelection();
      if(loadType == 'edit_pass')
      {
        $("#email").css("display","none");
        $("#user_entity").css("display","none");
        $("#user_place").css("display","none");
        $("#pass").css("display","table-row");
        $("#pass_c").css("display","table-row");
        $("#roles").css("display","none");
        $("#hide_email").attr("name", "");
      }
      else
      {
        uncheckRoles("enabled");
        $("#user_email").removeAttr('disabled');
        $("#user_email").val(email);
        $("#user_place_choose").removeAttr("disabled");
        $("#roles").css("display","block");
        if(loadType == 'new')
        {
          $("#user_entity_choose").removeAttr("disabled");
          $("#pass").css("display","table-row");
          $("#pass_c").css("display","table-row");
          roles = "";
        }
        else
        {
          $("#user_entity_choose").attr("disabled", "disabled");
          $('#hide_pass').attr('name', '');
          $('#hide_pass_c').attr('name', '');
        }
      }
      <% for role in Role.all %>
        $('#user_role_id_' + '<%= role.id.to_s %>').attr('checked',
                $('#role_ids_' + '<%= role.id.to_s %>').is(':checked'));
      <% end %>
    } else {
      loadUserElements();
    }
  }
  function viewIndexFrom()
  {
    location.hash = "#users";
    dataPage = null;
  }
  function onCancel()
  {
    viewIndexFrom();
  }
  function userChoiseEntity()
  {
    crossPage = "user";
    crossPageLink = "users/new";
    $("#users_div").css("display","none");
    $("#user_p_s_controls").css("display","block");
    $("#user_page_selection").html("<%= escape_javascript(render :partial => 'entities/index') %>");
    $("#user_submit").click(function() {
      var selRow = $("#entity_list").getGridParam("selrow");
      if (selRow != null)
      {
        $("#hide_user_entity_id").val(selRow);
        $("#user_entity_tag").val($("#entity_list").getCell(selRow, "tag"));
        showUserPage();
        $("#save_user").removeAttr('disabled');
      }
    });
  }
  function userChoisePlace()
  {
    crossPage = "user";
    crossPageLink = "users/new";
    $("#users_div").css("display","none");
    $("#user_p_s_controls").css("display","block");
    $("#user_page_selection").html("<%= escape_javascript(render :partial => 'places/index') %>");
    $("#user_submit").click(function() {
      var selRow = $("#place_list").getGridParam("selrow");
      if (selRow != null)
      {
        $("#hide_user_place_id").val(selRow);
        $("#user_place_tag").val($("#place_list").getCell(selRow, "tag"));
        showUserPage();
        $("#save_user").removeAttr('disabled');
      }
    });
  }
  function showUserPage()
  {
    $("#users_div").css("display","block");
    $("#user_p_s_controls").css("display","none");
    $("#user_page_selection").html("");
    $("#user_submit").unbind("click");
    crossPage = "";
  }
  function checkRoles(ids)
  {
    for(var i=0; i<ids.length; i++)
    {
      $("#user_role_id_" + ids[i]).attr("checked", "checked");
    }
  }
  function saveUserElements() {
    dataPage = new Object();
    dataPage["email"] = email;
    dataPage["roles"] = roles;
    dataPage["entity_id"] = entity_id;
    dataPage["entity_tag"] = entity_tag;
    dataPage["place_id"] = place_id;
    dataPage["place_tag"] = place_tag;
  }
  function loadUserElements() {
    if(dataPage != null) {
      email = dataPage["email"];
      roles = dataPage["roles"];
      entity_id = dataPage["entity_id"];
      entity_tag = dataPage["entity_tag"];
      place_id = dataPage["place_id"];
      place_tag = dataPage["place_tag"];
      dataPage = null;
    }
  }
</script>

<%= raw(users_jqgrid) %>

<div id="users_div">

  <table>
    <tr>
      <td colspan="3" id="user_errors"></td>
    </tr>
    <tr>
      <td colspan="3">
        <table id="data_list"></table>
        <div id="data_pager"></div>
      </td>
    </tr>
    <tr id="actions" align="right">
      <%= render 'form_index' %>
    </tr>
    <tr align="left" id="email" style="display: table-row">
      <td colspan="3">
        <%= t('user.email')%>:
        <input id="user_email" type="text" disabled="true" style="width: 661px"
               onkeypress="$('#save_user').removeAttr('disabled');" />
      </td>
    </tr>
    <tr align="left" id="user_entity" style="display: table-row">
      <td colspan="3">
        <%= t('user.entity')%>:
        <input id="user_entity_tag" type="text" disabled="true" style="width: 582px"/>
        <input id="user_entity_choose" type="button" value="<%= t('user.btn_choose')%>" disabled="true"
               onclick="userChoiseEntity();"/>
      </td>
    </tr>
    <tr align="left" id="user_place" style="display: table-row">
      <td colspan="3">
        <%= t('user.place')%>:
        <input id="user_place_tag" type="text" disabled="true" style="width: 586px"/>
        <input id="user_place_choose" type="button" value="<%= t('user.btn_choose')%>" disabled="true"
               onclick="userChoisePlace();"/>
      </td>
    </tr>
    <tr align="left" id="pass" style="display: none">
      <td colspan="3">
        <%= t('user.password')%>:
        <input id="user_pass" type="password" style="width: 635px"
               onkeypress="$('#save_user').removeAttr('disabled');" />
      </td>
    </tr>
    <tr align="left" id="pass_c" style="display: none">
      <td colspan="3">
        <%= t('user.password_confirmation')%>:
        <input id="user_pass_c" type="password" style="width: 544px"
               onkeypress="$('#save_user').removeAttr('disabled');" />
      </td>
    </tr>
    <tr id="roles" style="display: none">
      <td colspan="3">
        <p><%= t('user.roles')%>:</p>
        <% for role in Role.all %>
          <div>
            <%= check_box_tag "user_role_id_" + role.id.to_s, role.id, false,
                  :disabled => true,
                  :onchange => "$('#save_user').removeAttr('disabled');"%>
            <%= role.name %>
          </div>
        <% end %>
      </td>
    </tr>
  </table>
</div>

<table id="user_p_s_controls" style="display: none">
    <tr align="right">
      <td>
        <input type="button" value="<%= t('buttons.btn_discard')%>" onclick="showUserPage();"/>
        <input type="button" id="user_submit" value="<%= t('buttons.btn_submit')%>" onclick=""/>
      </td>
    </tr>
    <tr id="user_page_selection">
    </tr>
</table>

<script type="text/javascript">
  var filter = false;
  $("#data_list").filterToolbar({searchOnEnter : false});
  $("#data_list")[0].toggleToolbar();
</script>
